---
- name: Install Flannel CNI Network Plugin
  hosts: masters[0]
  become: false
  vars:
    ansible_ssh_common_args: '-o ProxyCommand="ssh -W %h:%p -q ec2-user@100.100.27.210 -i /home/ec2-user/.ssh/id_rsa  -o StrictHostKeyChecking=no"'
    flannel_version: "v0.22.3"
  tasks:
    - name: Check if Flannel is already installed
      shell: kubectl get pods -n kube-flannel | grep flannel
      register: flannel_check
      ignore_errors: true

    - name: Download Flannel manifest
      get_url:
        url: "https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml"
        dest: "/tmp/kube-flannel.yml"
        mode: '0644'
      when: flannel_check.rc != 0

    - name: Apply Flannel CNI
      shell: kubectl apply -f /tmp/kube-flannel.yml
      when: flannel_check.rc != 0

    - name: Wait for Flannel pods to be ready
      shell: kubectl get pods -n kube-flannel --field-selector=status.phase!=Running --no-headers
      register: flannel_pods
      until: flannel_pods.stdout == ""
      retries: 20
      delay: 15

    - name: Wait for all nodes to be ready
      shell: kubectl get nodes --no-headers | grep -v Ready | wc -l
      register: not_ready_nodes
      until: not_ready_nodes.stdout == "0"
      retries: 15
      delay: 20

    - name: Get cluster nodes status
      shell: kubectl get nodes -o wide
      register: nodes_status

    - name: Get Flannel pods status
      shell: kubectl get pods -n kube-flannel -o wide
      register: flannel_status

    - name: Get all system pods status
      shell: kubectl get pods -n kube-system
      register: system_pods

    - name: Display network setup results
      debug:
        msg: |
          âœ… Flannel CNI installed successfully!
          
          ğŸ“Š Cluster Nodes:
          {{ nodes_status.stdout }}
          
          ğŸŒ Flannel Pods:
          {{ flannel_status.stdout }}
          
          ğŸ”§ System Pods:
          {{ system_pods.stdout }}
          
          ğŸ‰ Network is ready! All nodes should be in 'Ready' state.
