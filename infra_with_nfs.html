<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS EFS Storage Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #2c3e50;
        }
        .header {
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .subtitle {
            color: #4361ee;
            font-weight: 500;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 6px;
            display: inline-block;
        }
        .description {
            color: #546e7a;
            max-width: 800px;
            margin: 0 auto 30px;
            line-height: 1.6;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            padding: 25px;
            margin-top: 20px;
        }
        .flowchart-container {
            overflow: auto;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            margin-bottom: 20px;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
            border: 2px solid;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        .export-btn {
            background: #4361ee;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            margin: 20px auto;
            box-shadow: 0 4px 6px rgba(67, 97, 238, 0.3);
        }
        .export-btn:hover {
            background: #3a56d4;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(67, 97, 238, 0.4);
        }
        .export-btn:active {
            transform: translateY(0);
        }
        .export-btn svg {
            margin-right: 8px;
        }
        .instructions {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            color: #2c3e50;
        }
        .instructions h3 {
            margin-top: 0;
            color: #4361ee;
        }
        .architecture-note {
            background: #fff4e6;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffa94d;
        }
        .architecture-note h3 {
            color: #e67700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .architecture-note h3 svg {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AWS EFS Storage Architecture</h1>
        <p class="subtitle">Multi-AZ Kubernetes Cluster with Shared EFS Storage</p>
        <p class="description">
            This optimized diagram shows how Amazon EFS provides shared storage for a Kubernetes cluster spanning multiple Availability Zones.
        </p>
    </div>
    
    <div class="container">
        <div class="architecture-note">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Architecture Notes
            </h3>
            <p>Amazon EFS provides a shared file system that can be accessed concurrently from all nodes in the Kubernetes cluster, regardless of which Availability Zone they're in. This solves the cross-AZ storage access problem.</p>
        </div>
        
        <button class="export-btn" id="exportBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export as PNG
        </button>
        
        <div class="flowchart-container" id="flowchart">
            <div class="mermaid">
flowchart TB
    Internet["Internet"] --> IGW["Internet Gateway"]
    
    subgraph AWS_Region["AWS Region: us-east-1"]
        subgraph VPC["VPC: 10.0.0.0/16"]
            IGW
            
            %% EFS File System (Shared across all AZs)
            EFS[("Amazon EFS<br>Shared File System")]
            
            subgraph AZ_A["Availability Zone A"]
                subgraph Public_A["Public Subnet"]
                    Bastion["Bastion Host<br>10.0.2.10"]
                    NAT_A["NAT Gateway A"]
                end
                
                subgraph Private_A["Private Subnet"]
                    Master1["Master Node 1<br>10.0.1.10"]
                    Worker1["Worker Node 1<br>10.0.1.11"]
                    Worker2["Worker Node 2<br>10.0.1.12"]
                end

                subgraph Etcd_A["Etcd Subnet AZ-A"]
                    Etcd1["Etcd Node A<br>10.0.4.10"]
                end
            end
            
            subgraph AZ_B["Availability Zone B"]
                subgraph Public_B["Public Subnet"]
                    ALB["Application Load Balancer"]
                    NAT_B["NAT Gateway B"]
                end
                
                subgraph Private_B["Private Subnet"]
                    Master2["Master Node 2<br>10.0.3.10"]
                    Worker3["Worker Node 3<br>10.0.3.11"]
                    Worker4["Worker Node 4<br>10.0.3.12"]
                end

                subgraph Etcd_B["Etcd Subnet AZ-B"]
                    Etcd2["Etcd Node B<br>10.0.5.10"]
                end
            end
        end
    end

    %% Internet Connectivity
    IGW --> ALB
    IGW --> Bastion
    
    %% Bastion Host Management Access
    Bastion -.->|SSH| Master1
    Bastion -.->|SSH| Master2
    Bastion -.->|SSH| Etcd1
    Bastion -.->|SSH| Etcd2
    
    %% Master Node Communication with Etcd
    Master1 <-->|etcd| Etcd1
    Master2 <-->|etcd| Etcd2

    %% Load Balancer to Workers - rearranged to avoid overlaps
    ALB -->|traffic| Worker2
    ALB -->|traffic| Worker1
    ALB -->|traffic| Worker3
    ALB -->|traffic| Worker4
    
    %% EFS Storage Connections - Linked to subnets instead of individual nodes
    EFS -.->|NFS| Private_A
    EFS -.->|NFS| Private_B
    
    %% NAT Gateway Connectivity
    NAT_A -.-> Private_A
    NAT_B -.-> Private_B

    %% Styling
    classDef master fill:#FECACA,stroke:#dc2626,stroke-width:2px,color:#000
    classDef worker fill:#BFDBFE,stroke:#2563eb,stroke-width:2px,color:#000
    classDef nat fill:#FDE68A,stroke:#f59e0b,stroke-width:2px,color:#000
    classDef alb fill:#FDBA74,stroke:#ea580c,stroke-width:2px,color:#000
    classDef storage fill:#A78BFA,stroke:#6D28D9,stroke-width:2px,color:#000
    classDef access fill:#BBF7D0,stroke:#16a34a,stroke-width:2px,color:#000
    classDef igw fill:#99F6E4,stroke:#059669,stroke-width:2px,color:#000
    classDef etcd fill:#FDE8FF,stroke:#9b5cf6,stroke-width:2px,color:#000
    classDef efs fill:#A78BFA,stroke:#6D28D9,stroke-width:2px,color:#000
    classDef subnet fill:#E0E7FF,stroke:#4F46E5,stroke-width:1px,color:#000

    Bastion:::access
    NAT_A:::nat
    NAT_B:::nat
    Master1:::master
    Master2:::master
    Worker1:::worker
    Worker2:::worker
    Worker3:::worker
    Worker4:::worker
    ALB:::alb
    IGW:::igw
    Etcd1:::etcd
    Etcd2:::etcd
    EFS:::efs
    Private_A:::subnet
    Private_B:::subnet

    %% Link styles for better visibility
    linkStyle 0,1,2,3,4,5,6,7,8,9,10,11,12,13 stroke-width:2px
    linkStyle 14,15 stroke-width:2px,stroke-dasharray:5 5
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FECACA; border-color: #dc2626"></div>
                <span>Master Nodes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #BFDBFE; border-color: #2563eb"></div>
                <span>Worker Nodes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FDE68A; border-color: #f59e0b"></div>
                <span>NAT Gateway</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FDBA74; border-color: #ea580c"></div>
                <span>Load Balancer</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #A78BFA; border-color: #6D28D9"></div>
                <span>EFS Storage</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #BBF7D0; border-color: #16a34a"></div>
                <span>Bastion Host</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #99F6E4; border-color: #059669"></div>
                <span>Internet Gateway</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FDE8FF; border-color: #9b5cf6"></div>
                <span>Etcd Nodes</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #E0E7FF; border-color: #4F46E5"></div>
                <span>Private Subnets</span>
            </div>
        </div>
        
        <div class="instructions">
            <h3>How EFS Solves the Cross-AZ Storage Problem</h3>
            <p>Amazon EFS provides a fully managed, shared file system that can be mounted concurrently by multiple EC2 instances across different Availability Zones. This allows all nodes in your Kubernetes cluster to access the same storage regardless of which AZ they're running in.</p>
            <p>Key benefits:</p>
            <ul>
                <li>Shared access across all AZs in a region</li>
                <li>Elastic capacity that grows and shrinks automatically</li>
                <li>High availability and durability</li>
                <li>Compatible with Kubernetes through the EFS CSI driver</li>
                <li>Pay only for the storage you use</li>
            </ul>
        </div>
    </div>
    
    <div class="footer">
        <p>AWS EFS Storage Architecture Diagram | Created with Mermaid.js</p>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: true, 
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Segoe UI'
        });
        
        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            // Show loading state
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Generating...';
            btn.disabled = true;
            
            // Use html2canvas to capture the flowchart
            setTimeout(() => {
                html2canvas(document.getElementById('flowchart'), {
                    scale: 2, // Higher quality
                    logging: false,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    // Convert canvas to image and download
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = 'aws-efs-architecture.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Reset button
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }).catch(err => {
                    console.error('Error generating image:', err);
                    alert('Error generating image. Please try again.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }, 500);
        });
    </script>
</body>
</html>